<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Calendar | FreeBizTools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .day {
            background-color: #ffffff;
            height: 120px; /* Fixed height for consistent layout */
            position: relative;
            padding: 0.5rem;
            overflow: hidden;
            transition: background-color 0.2s ease;
        }
        .day:hover {
            background-color: #f3f4f6;
        }
        .day.inactive {
            background-color: #f9fafb;
            color: #d1d5db;
        }
        .day-header {
            background-color: #f3f4f6;
            text-align: center;
            font-weight: 600;
            padding: 0.75rem 0;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .event-item {
            background-color: #6366f1;
            color: white;
            padding: 0.25rem;
            margin-top: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .modal.open {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            color: #9ca3af;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white shadow-sm py-4 px-6 md:px-12 lg:px-24 flex items-center justify-between rounded-b-lg">
        <div class="text-xl font-semibold text-gray-800">FreeBizTools</div>
        <nav class="hidden md:flex space-x-8">
            <a href="#" class="text-gray-600 hover:text-gray-900 font-medium">Home</a>
            <a href="#" class="text-gray-900 font-medium border-b-2 border-gray-800">Marketing Calendar</a>
            <a href="#" class="text-gray-600 hover:text-gray-900 font-medium">Persona Builder</a>
            <a href="#" class="text-gray-600 hover:text-gray-900 font-medium">CRM Lite</a>
            <a href="#" class="text-gray-600 hover:text-gray-900 font-medium">Contact</a>
        </nav>
        <div class="flex items-center space-x-4">
            <!-- User Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-600 cursor-pointer"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <!-- Bell Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-600 cursor-pointer"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 md:px-12 lg:px-24">
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Marketing Calendar</h1>
            <p class="text-gray-600 mb-6">Plan and track your marketing activities throughout the month.</p>

            <div id="user-info" class="text-sm text-gray-500 mb-4">
              <span class="font-medium">User ID:</span> <span id="user-id">Loading...</span>
            </div>

            <!-- Calendar Navigation -->
            <div class="flex justify-between items-center mb-6">
                <button id="prevMonth" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 transition duration-200">&lt; Prev</button>
                <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-800"></h2>
                <button id="nextMonth" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 transition duration-200">Next &gt;</button>
            </div>
            
            <!-- Calendar Grid -->
            <div id="calendar-grid" class="calendar-grid mb-6">
                <!-- Day cells will be dynamically generated here -->
            </div>
        </div>
    </main>

    <!-- Event Modal Form -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modalCloseBtn">&times;</span>
            <h3 id="modalTitle" class="text-xl font-bold mb-4">Add Event</h3>
            <form id="eventForm" class="space-y-4">
                <div>
                    <label for="eventTitle" class="block text-gray-700 font-medium mb-1">Event Title</label>
                    <input type="text" id="eventTitle" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 'Email Newsletter'" required>
                </div>
                <div>
                    <label for="eventDescription" class="block text-gray-700 font-medium mb-1">Description</label>
                    <textarea id="eventDescription" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Briefly describe the event"></textarea>
                </div>
                <div>
                    <label for="eventChannel" class="block text-gray-700 font-medium mb-1">Channel</label>
                    <input type="text" id="eventChannel" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 'Email', 'Social Media'">
                </div>
                <input type="hidden" id="eventDate">
                <input type="hidden" id="eventId">
                <div class="flex justify-end gap-2">
                    <button type="submit" id="saveEventBtn" class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-700 transition duration-200">Save</button>
                    <button type="button" id="deleteEventBtn" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 transition duration-200">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to delete this event?</p>
            <div class="flex justify-end gap-2">
                <button id="cancelDeleteBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-md hover:bg-gray-300 transition duration-200">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 transition duration-200">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase imports - using v11.6.1 as per best practices
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables provided by the environment ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Global Firebase State ---
        let db, auth;
        let userId;

        // --- UI Element Selectors ---
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const eventModal = document.getElementById('eventModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTitle = document.getElementById('modalTitle');
        const eventForm = document.getElementById('eventForm');
        const eventTitleInput = document.getElementById('eventTitle');
        const eventDescriptionInput = document.getElementById('eventDescription');
        const eventChannelInput = document.getElementById('eventChannel');
        const eventDateInput = document.getElementById('eventDate');
        const eventIdInput = document.getElementById('eventId');
        const deleteEventBtn = document.getElementById('deleteEventBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const userIdDisplay = document.getElementById('user-id');

        // --- App State ---
        let currentMonth = new Date();
        let events = []; // Array to hold all events from Firestore
        let eventToDeleteId = null;

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in with custom token or anonymously if not available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || null;
                if (userId) {
                    userIdDisplay.textContent = userId;
                    listenForEvents();
                } else {
                    userIdDisplay.textContent = 'Could not get user ID';
                }
                
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
            }
        };

        // --- Data Persistence Functions (Firestore) ---
        const listenForEvents = () => {
            if (!db || !userId) return;

            const eventsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/marketing_events`);

            // Listen for real-time changes
            onSnapshot(eventsCollectionRef, (querySnapshot) => {
                const fetchedEvents = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedEvents.push({
                        id: doc.id,
                        ...data,
                        date: data.date.toDate() // Convert Firestore Timestamp to JS Date object
                    });
                });
                events = fetchedEvents; // Update the global events array
                renderCalendar();
            }, (error) => {
                console.error("Error fetching events: ", error);
            });
        };

        const saveEvent = async (eventData) => {
            if (!db || !userId) return;
            
            try {
                if (eventData.id) {
                    // Update existing event
                    const eventDocRef = doc(db, `artifacts/${appId}/users/${userId}/marketing_events`, eventData.id);
                    await setDoc(eventDocRef, { 
                        title: eventData.title,
                        description: eventData.description,
                        channel: eventData.channel,
                        date: Timestamp.fromDate(new Date(eventData.date))
                    }, { merge: true });
                } else {
                    // Add new event
                    const eventsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/marketing_events`);
                    await addDoc(eventsCollectionRef, {
                        title: eventData.title,
                        description: eventData.description,
                        channel: eventData.channel,
                        date: Timestamp.fromDate(new Date(eventData.date)),
                        createdAt: Timestamp.now()
                    });
                }
            } catch (e) {
                console.error("Error saving event: ", e);
            }
        };
        
        const deleteEvent = async (eventId) => {
            if (!db || !userId || !eventId) return;

            try {
                const eventDocRef = doc(db, `artifacts/${appId}/users/${userId}/marketing_events`, eventId);
                await deleteDoc(eventDocRef);
            } catch (e) {
                console.error("Error deleting event: ", e);
            }
        };

        // --- UI Rendering and Logic ---
        const renderCalendar = () => {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            currentMonthYear.textContent = `${currentMonth.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayIndex = firstDay.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const totalDays = lastDay.getDate();

            calendarGrid.innerHTML = `
                <div class="day-header">Sun</div>
                <div class="day-header">Mon</div>
                <div class="day-header">Tue</div>
                <div class="day-header">Wed</div>
                <div class="day-header">Thu</div>
                <div class="day-header">Fri</div>
                <div class="day-header">Sat</div>
            `;

            // Render inactive days from the previous month
            for (let i = 0; i < startDayIndex; i++) {
                const prevMonthDate = new Date(year, month, 0 - startDayIndex + i + 1);
                const prevMonthDay = document.createElement('div');
                prevMonthDay.classList.add('day', 'inactive');
                prevMonthDay.innerHTML = `<span class="text-sm font-semibold">${prevMonthDate.getDate()}</span>`;
                calendarGrid.appendChild(prevMonthDay);
            }

            // Render active days
            for (let day = 1; day <= totalDays; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('day', 'flex', 'flex-col');
                const date = new Date(year, month, day);
                dayDiv.dataset.date = date.toISOString().split('T')[0];
                dayDiv.innerHTML = `<span class="text-sm font-semibold text-gray-900">${day}</span>`;
                
                // Add click listener for adding a new event
                dayDiv.addEventListener('click', () => {
                    openModal(date);
                });

                // Add events for this day
                const dayEvents = events.filter(e => {
                    const eventDate = new Date(e.date);
                    return eventDate.getFullYear() === year && eventDate.getMonth() === month && eventDate.getDate() === day;
                });
                
                dayEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('event-item');
                    eventDiv.textContent = event.title;
                    eventDiv.dataset.eventId = event.id; // Store ID for editing
                    
                    // Add click listener for editing an existing event
                    eventDiv.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the day's click event from firing
                        openModal(null, event);
                    });

                    dayDiv.appendChild(eventDiv);
                });

                calendarGrid.appendChild(dayDiv);
            }
        };

        const openModal = (date, event = null) => {
            eventForm.reset();
            eventIdInput.value = '';
            deleteEventBtn.classList.add('hidden');
            
            if (event) {
                modalTitle.textContent = 'Edit Event';
                eventTitleInput.value = event.title;
                eventDescriptionInput.value = event.description || '';
                eventChannelInput.value = event.channel || '';
                eventDateInput.value = event.date.toISOString().split('T')[0];
                eventIdInput.value = event.id;
                deleteEventBtn.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'Add New Event';
                eventDateInput.value = date.toISOString().split('T')[0];
            }
            
            eventModal.classList.add('open');
        };

        const closeModal = () => {
            eventModal.classList.remove('open');
        };

        const openDeleteModal = (eventId) => {
            eventToDeleteId = eventId;
            deleteConfirmModal.classList.add('open');
        };

        const closeDeleteModal = () => {
            deleteConfirmModal.classList.remove('open');
            eventToDeleteId = null;
        };

        // --- Event Listeners ---
        prevMonthBtn.addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const eventData = {
                title: eventTitleInput.value,
                description: eventDescriptionInput.value,
                channel: eventChannelInput.value,
                date: eventDateInput.value,
                id: eventIdInput.value || null
            };
            await saveEvent(eventData);
            closeModal();
        });

        deleteEventBtn.addEventListener('click', () => {
            openDeleteModal(eventIdInput.value);
            closeModal(); // Close the event form modal
        });
        
        // Confirmation modal buttons
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            await deleteEvent(eventToDeleteId);
            closeDeleteModal();
        });

        modalCloseBtn.addEventListener('click', closeModal);

        window.addEventListener('load', () => {
            initFirebase();
            // The calendar will be rendered by the onSnapshot listener after data is fetched.
        });
    </script>
</body>
</html>
